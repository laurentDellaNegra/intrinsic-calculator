---
import { rawHtmlFinancials } from '../../dummy/GOOGfinancials'
import { rawHtmlCompany } from '../../dummy/GOOGcompany'
import { getFinancial } from './financial'
import { getCompany } from './company'
import { createTable, getRows, HistoricalTableCell } from './historical'

// const { ticker } = Astro.params
// const response1 = await fetch(`https://roic.ai/financials/${ticker}`)
// const rawHtmlFinancials = await response1.text()
// const response2 = await fetch(`https://roic.ai/company/${ticker}`)
// const rawHtmlCompany = await response2.text()

const financial = getFinancial(rawHtmlFinancials)
const company = getCompany(rawHtmlCompany)
const table = createTable(company, financial)
// Get all rows except year
const rows = getRows(table)

// Average to last 3 years of EPS
// const eps3YearsAvg = average(financial.table.slice(-3).map((t) => t.eps))
// const fcf3YearsAvg = average(financial.table.slice(-3).map((t) => t.fcf))
---

<!-- {JSON.stringify(rows, null, 2)} -->
<div class="flow-root">
  <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
    <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
      <table class="min-w-full divide-y divide-gray-500">
        <thead>
          <tr>
            <th
              scope="col"
              class="whitespace-nowrap py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-0"
            ></th>
            {
              table.year.map((a) => (
                <th
                  scope="col"
                  class="whitespace-nowrap py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-0"
                >
                  {a}
                </th>
              ))
            }
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
          {
            rows.map((row) => (
              <tr>
                <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm font-semibold text-white sm:pl-0">
                  {row.label}
                </td>
                {table[row.key].map((a: HistoricalTableCell) => (
                  <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-300 sm:pl-0">
                    {a.displayedValue}
                  </td>
                ))}
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // TODO: delete
  import { rawHtmlFinancials } from '../../dummy/GOOGfinancials'
  import { rawHtmlCompany } from '../../dummy/GOOGcompany'
  import { getFinancial } from './financial'
  import { getCompany } from './company'

  import { createTable, getRows } from './historical'
  // const response = await fetch('https://roic.ai/financials/GOOG')
  // const rawHtml2 = await response.text()
  // const response = await fetch('https://roic.ai/company/GOOG')
  // const rawHtml2 = await response.text()

  const financial = getFinancial(rawHtmlFinancials)
  const company = getCompany(rawHtmlCompany)
  const table = createTable(company, financial)
  const rows = getRows(table)
  console.log(rows)
</script>
